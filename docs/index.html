<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <title>neo4jd3.js</title>
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/font-awesome.min.css">
        <link rel="stylesheet" href="css/neo4jd3.min.css">
        <style>
            body,
            html,
            .neo4jd3 {
                height: 100%;
                overflow: hidden;
            }
        </style>
    </head>
    <body>
        <div id="neo4jd3"></div>
        <a href="https://github.com/eisman/neo4jd3"></a>

        <!-- Scripts -->
        <script src="js/d3.min.js"></script>
        <script src="js/jquery.min.js"></script>
        <script src="js/pako.min.js"></script>
        <script src="js/spin.min.js"></script>
        <script src="js/neo4jd3.js?v=0.0.1"></script>
        <script type="text/javascript">

            function decompressB64(b64Data) {

                // Decode base64 (convert ascii to binary)
                var strData  = atob(b64Data);

                // Convert binary string to character-number array
                var charData = strData.split('').map(function(x){return x.charCodeAt(0);});

                // Turn number array into byte-array
                var binData = new Uint8Array(charData);

                // Pako magic
                var data = pako.inflate(binData);

                // var restored = String.fromCharCode.apply(null, new Uint16Array(data));

                var restored = new Uint16Array(data).reduce(function (data, byte) {
                    return data + String.fromCharCode(byte);
                }, '');

                return restored;
            }

            function decompressGraph(data) {
                data.nodes = JSON.parse(decompressB64(data.nodes));
                data.relationships = JSON.parse(decompressB64(data.relationships));
                return data;
            }

            function renameField(o, old_key, new_key) {
                if (old_key !== new_key) {
                    Object.defineProperty(o, new_key,
                        Object.getOwnPropertyDescriptor(o, old_key));
                    delete o[old_key];
                }
            }

            function push2Properties(o, key) {
                props = o.properties;
                Object.defineProperty(props, key,
                    Object.getOwnPropertyDescriptor(o, key));
                //delete o[key];
            }


            function init() {
                var neo4jd3 = new Neo4jd3('#neo4jd3', {
                    classes2colors: {
                        'CitiAccount': '#68bdf6', // light blue
                        'Account': '#6dce9e' // green #1
                    },
                    highlight: [
                        {
                            class: 'Project',
                            property: 'name',
                            value: 'neo4jd3'
                        }, {
                            class: 'User',
                            property: 'userId',
                            value: 'eisman'
                        }
                    ],
                    icons: {
                       /*  'CitiAccount': 'university',
                        'Account': 'user',
//                        'Address': 'home',
                        'Api': 'gear',
//                        'BirthDate': 'birthday-cake',
                        'Cookie': 'paw',
//                        'CreditCard': 'credit-card',
//                        'Device': 'laptop',
                        'Email': 'at',
                        'Git': 'git',
                        'Github': 'github',
                        'Google': 'google',
//                        'icons': 'font-awesome',
                        'Ip': 'map-marker',
                        'Issues': 'exclamation-circle',
                        'Language': 'language',
                        'Options': 'sliders',
                        'Password': 'lock',
                        'Phone': 'phone',
                        'Project': 'folder-open',
                        'SecurityChallengeAnswer': 'commenting',
                        'User': 'user',
                        'zoomFit': 'arrows-alt',
                        'zoomIn': 'search-plus',
                        'zoomOut': 'search-minus' */
                    },
                    images: {
                       /*  'CitiAccount': 'img/twemoji/1f4b3.svg',
                        'Account': 'img/twemoji/1f527.svg',
                        'Address': 'img/twemoji/1f3e0.svg',
//                        'Api': 'img/twemoji/1f527.svg',
                        'BirthDate': 'img/twemoji/1f382.svg',
                        'Cookie': 'img/twemoji/1f36a.svg',
                        'CreditCard': 'img/twemoji/1f4b3.svg',
                        'Device': 'img/twemoji/1f4bb.svg',
                        'Email': 'img/twemoji/2709.svg',
                        'Git': 'img/twemoji/1f5c3.svg',
                        'Github': 'img/twemoji/1f5c4.svg',
                        'icons': 'img/twemoji/1f38f.svg',
                        'Ip': 'img/twemoji/1f4cd.svg',
                        'Issues': 'img/twemoji/1f4a9.svg',
                        'Language': 'img/twemoji/1f1f1-1f1f7.svg',
                        'Options': 'img/twemoji/2699.svg',
                        'Password': 'img/twemoji/1f511.svg',
//                        'Phone': 'img/twemoji/1f4de.svg',
                        'Project': 'img/twemoji/2198.svg',
                        'Project|name|neo4jd3': 'img/twemoji/2196.svg',
//                        'SecurityChallengeAnswer': 'img/twemoji/1f4ac.svg',
                        'User': 'img/twemoji/1f600.svg'
//                        'zoomFit': 'img/twemoji/2194.svg',
//                        'zoomIn': 'img/twemoji/1f50d.svg',
//                        'zoomOut': 'img/twemoji/1f50e.svg' */
                    },
                    minCollision: 80,
                    /* d3DataUrl: 'json/d3Data.json', */
                    d3DataUrl: 'json/CHASLULX_6550220357.json',
                    neo4jDataUrl: 'json/neo4jData.json',
                    nodeRadius: 25,
                    onNodeDoubleClick: function(node) {
                        // switch(node.id) {
                        //     case '25':
                        //         // Google
                        //         window.open(node.properties.url, '_blank');
                        //         break;
                        //     default:
                        //         var maxNodes = 5,
                        //             data = neo4jd3.randomD3Data(node, maxNodes);
                        //         neo4jd3.updateWithD3Data(data);
                        //         break;
                        // }
                    },
                    onRelationshipDoubleClick: function(relationship) {
                        console.log('double click on relationship: ' + JSON.stringify(relationship));
                    },
                    onDataLoad: (data) => {
                        // Decompress graph
                        //var data = decompressGraph(data);

                        const rScale = d3.scaleLinear()
                                .domain([
                                    Math.round(d3.min(data.nodes, d => d.rank_value * 1e09)),
                                    Math.round(d3.max(data.nodes, d => d.rank_value * 1e09))
                                ])
                                .range([25, 75]);
                        // console.log("min of rank_value: " + Math.round(d3.min(data.nodes, d => d.rank_value * 1e09)));
                        // console.log("max of rank_value: " + Math.round(d3.max(data.nodes, d => d.rank_value * 1e09)));

                        data.nodes.forEach(function(n, i) { 
                            
                            // multiply the rank value to make it consumable
                            n.rank_value = n.rank_value * 1e09;

                            // right format for the viz
                            if (n.bank_bic.startsWith('CITI')) {
                                n.labels = ['CitiAccount']; 
                            } else {
                                n.labels = ['Account']; 
                            }
                            n.properties = {};
                            push2Properties(n, "bank_bic");
                            push2Properties(n, "account_id");
                            push2Properties(n, "rank_value");
                            push2Properties(n, "total_sent");
                            push2Properties(n, "total_received");
                            n.properties.total_sent = d3.format("(,.2f")(n.total_sent);
                            n.properties.total_received = d3.format("(,.2f")(n.total_received);
                            n.properties.rank_value = d3.format("(,.2f")(n.rank_value);
                            
                            // set the radius based on the rank_value
                            n.radius = Math.round(rScale(Math.round(n.rank_value)));
                            
                        });
                        data.relationships.forEach(function(r, i) { 
                            
                            // right format for the viz
                            r.type = "Sent";
                            renameField(r, "edgeId", "id");
                            renameField(r, "originId", "source");
                            renameField(r, "destinationId", "target");
                            r.properties = {}; 
                            push2Properties(r, "amount");
                            push2Properties(r, "send_bank_bic");
                            push2Properties(r, "send_account_id");
                            push2Properties(r, "send_gfpid");
                            push2Properties(r, "send_gfcid");
                            push2Properties(r, "send_bank_ctry_code");
                            push2Properties(r, "bene_bank_bic");
                            push2Properties(r, "bene_account_id");
                            push2Properties(r, "bene_gfpid");
                            push2Properties(r, "bene_gfcid");
                            push2Properties(r, "bene_bank_ctry_code");
                            // format fields
                            r.properties.amount = d3.format("(,.2f")(r.amount);

                        });
                    },
                    zoomFit: false,
                    showNodeLabelsIfNoIcons: false
                });
            }

            window.onload = init;
        </script>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-430863-29', 'auto');
          ga('send', 'pageview');
        </script>
    </body>
</html>
